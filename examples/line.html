<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="common.css">
  </head>
  <body>
    <div id="container"></div>
    <div id="container2"></div>
    <script src="../components/require/require.js"></script>
    <script src="../requirejs.conf.js"></script>
    <script>
      require(['glimpse'], function (glimpse) {
        'use strict';

        var latencyData = [{
            data: [
            {"time":1317279600000,"latency":106.19392367079854},
            {"time":1317695968421.0527,"latency":56.03559841401875},
            {"time":1318112336842.1052,"latency":126.56398699618876},
            {"time":1318528705263.158,"latency":197.48531440272927},
            {"time":1318945073684.2104,"latency":134.64964700397104},
            {"time":1319361442105.2632,"latency":114.76828635204583},
            {"time":1319777810526.3157,"latency":77.50583724118769},
            {"time":1320194178947.3684,"latency":74.262569937855},
            {"time":1320610547368.4211,"latency":124.86097845248878},
            {"time":1321026915789.4736,"latency":88.70440365280956},
            {"time":1321443284210.5264,"latency":126.80981094017625},
            {"time":1321859652631.5789,"latency":115.363494399935},
            {"time":1322276021052.6316,"latency":100.65460556652397}]
          }];

        var data = [
              { id: 'latencyOrd',
                title: 'Time to Connect (ORD)',
                data: latencyData[0].data,
                dimensions: {
                  x: 'time',
                  y: function (d, i) { return d.latency + 10; }
                }
              },
              { id: 'latencyLon',
                title: 'Time to Connect (LON)',
                data: latencyData[0].data,
                dimensions: { x: 'time', y: 'latency' }
              }, { id: 'latencyDfw',
                title: 'Time to Connect (DFW)',
                data: latencyData[0].data,
                dimensions: { x: 'time', y: 'latency' }
              },
              {
                id: 'latencyDfwROC',
                title: 'Difference Quotient (DFW)',
                sources: 'latencyDfw',
                derivation: function(sources) {
                  return sources.diffQuotient().get();
                }
              },
              {
                id: 'stats',
                sources: ['*', '$domain'],
                derivation: function(sources, domain) {
                  var xDomain = domain.get()['x'],
                      points = sources.filter('x', xDomain).dim('y').concat();
                  return {
                    min: points.min().round().get(),
                    max: points.max().round().get(),
                    avg: points.avg().round().get()
                  };
                }
              }
            ];

          var lineGraph = glimpse.graph()
            .config({
              forceY: [0]
            })
            .component({ type: 'line', dataId: 'latencyDfw', color: '#e65b1f' })
            .component({ type: 'line', dataId: 'latencyDfwROC', color: '#206ec2' })
            .component({ type: 'label', dataId: 'stats',
              text: function(d) {
                return 'Min: ' + d.min + ' Max: ' + d.max + ' Avg: ' + d.avg;
              },
              position: 'center-left', target: '.gl-footer' })
            .state('loading')
            .render('#container');

          window.setTimeout(function() {
            lineGraph.data(data)
              .state('normal')
              .update();
          }, 500);

          var lineGraph2 = glimpse.graph()
            .config({
              width: 350,
              height: 115
            })
            .data([
              { id: 'latencyDfw',
                title: 'Time to Connect (DFW)',
                data: latencyData[0].data,
                dimensions: { x: 'time', y: 'latency' }
              },
              { id: 'latencyOrd',
                title: 'Time to Connect (ORD)',
                data: latencyData[0].data,
                dimensions: {
                  x: 'time',
                  y: function (d, i) { return d.latency + 10; }
                }
              },
              { id: 'latencyLon',
                title: 'Time to Connect (LON)',
                data: latencyData[0].data,
                dimensions: {
                  x: 'time',
                  y: function (d, i) { return d.latency + Math.random()*50; }
                }
              },
              {
                id: 'latencyAvg',
                sources: '*',
                derivation: function(sources) {
                  return sources.dim('x').concat().avg().get();
                }
              }
            ])
            .component({ type: 'line', dataId: 'latencyDfw', color: '#e65b1f' })
            .component({ type: 'line', dataId: 'latencyOrd', color: '#206ec2' })
            .component({ type: 'line', dataId: 'latencyLon', color: '#c40022' })
            .render('#container2');

            // for debugging
            window.graph = lineGraph;
            window.gl = glimpse;
        });
    </script>
  </body>
</html>

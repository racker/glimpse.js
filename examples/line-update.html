<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="common.css">
  </head>
  <body>
    <div id="box">
      <button id="update">Update</button>
      <div id="container"></div>
    </div>
    <script src="../components/require/require.js"></script>
    <script src="../requirejs.conf.js"></script>
    <script>
      require(['glimpse'], function (glimpse) {
        'use strict';
        var epochBaseMs,
          oneDayMs,
          latencyData,
          lineGraph,
          currentDay,
          currentDay,
          update;

        epochBaseMs = new Date().getTime();
        oneDayMs = 1000 * 60 * 60 * 24;

        latencyData = [
          {
            data: [
              {"time":epochBaseMs + 0 * oneDayMs,"latency": 80},
              {"time":epochBaseMs + 1 * oneDayMs,"latency": 120},
              {"time":epochBaseMs + 2 * oneDayMs,"latency": 60},
              {"time":epochBaseMs + 3 * oneDayMs,"latency": 90},
              {"time":epochBaseMs + 4 * oneDayMs,"latency": 100}
            ]
          }
        ];

        lineGraph = glimpse.graph()
          .config({
            width: 700,
            height: 250,
            domainIntervalUnit: d3.time.week,
            forceY: [0]
          })
          .data([
            {
              id: 'latencyDfw',
              title: 'Time to Connect (DFW)',
              data: latencyData[0].data,
              dimensions: {
                x: function (d, i) { return d.time + 5; },
                y: function (d, i) { return d.latency + 10; }
              }
            },
            {
              id: 'latencyOrd',
              title: 'Time to Connect (ORD)',
              data: latencyData[0].data,
              dimensions: { x: 'time', y: 'latency' }
            },
            { id: 'latencyLon',
                title: 'Time to Connect (LON)',
                data: latencyData[0].data,
                dimensions: {
                  x: function (d, i) { return d.time; },
                  y: function (d, i) { return d.latency + Math.random()*10; }
                }
              },
              {
                id: 'stats',
                sources: '*',
                derivation: function(sources) {
                  var points = sources.dim('y').concat();
                  return {
                    min: points.min().round().get(),
                    max: points.max().round().get(),
                    avg: points.avg().round().get()
                  };
                }
              }
          ])
          .component({ cid: 'lineOrd', type: 'line', dataId: 'latencyOrd', color: '#206ec2', opacity: '0.4' })
          .component({ cid: 'lineDfw', type: 'line', dataId: 'latencyDfw', color: '#e65b1f', opacity: '0.6'  })
          .component({ cid: 'lineLon', type: 'line', dataId: 'latencyLon', color: '#c40022', opacity: '0.7'  })
          .component({ type: 'label', dataId: 'stats',
              text: function(d) {
                return 'Min/Max/Avg: ' + d.min + '/' + d.max + '/' + d.avg
              },
              position: 'center-left', target: '.gl-footer' })
          .render('#container');

        currentDay = latencyData[0].data.length;

        //for debugging
        window.graph = lineGraph;

        update = function () {
          lineGraph.appendData(
              'latencyOrd',
              {"time":epochBaseMs + currentDay++ * oneDayMs, "latency": (Math.random() * 150)}
            )
            .update()
            .hide('lineOrd');
        };

        document.getElementById('update').addEventListener('click', update, false);
      });
    </script>
  </body>
</html>
